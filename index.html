<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GitHub Private Drive</title>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css' />
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

    <style>
        #drive-ui { padding: 20px; font-family: sans-serif; }
        .file-item { cursor: pointer; color: blue; text-decoration: underline; margin: 10px 0; }
        #editor-ui { display: none; }
        .controls { position: absolute; top: 5px; right: 20px; z-index: 1000; }
    </style>
</head>
<body>

    <div id="drive-ui">
        <h1>My Spreadsheet Drive</h1>
        <button onclick="createNewSheet()">+ Create New Spreadsheet</button>
        <div id="file-list">Loading files...</div>
    </div>

    <div id="editor-ui">
        <div class="controls">
            <button onclick="saveCurrentSheet()" style="background: green; color: white;">SAVE TO GITHUB</button>
            <button onclick="location.reload()">BACK TO DRIVE</button>
        </div>
        <div id="luckysheet" style="margin:0px;padding:0px;position:absolute;width:100%;height:95%;left:0px;top:40px;"></div>
    </div>

    <script>
        const CONFIG = {
            token: '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', 
            owner: 'patrickwoolf',
            repo: 'spreadsheets',
            folder: 'my-sheets'
        };

        let currentFileSha = '';
        let currentFileName = '';

        // --- 1. LIST FILES ---
        async function loadFileList() {
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}`, {
                    headers: { 'Authorization': `token ${CONFIG.token}` }
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    console.error("GitHub API Error:", errorData.message);
                    alert("GitHub says: " + errorData.message); // This will pop up the actual error
                    return;
                }
        
                const files = await res.json();
                console.log("Files found:", files);
                // ... rest of your code
            } catch (err) {
                console.error("Network or Script Error:", err);
            }
        }
        // --- 2. OPEN SHEET ---
        async function openSheet(name, sha) {
            currentFileName = name;
            currentFileSha = sha;
            
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                headers: { 'Authorization': `token ${CONFIG.token}` }
            });
            const fileData = await res.json();
            const content = JSON.parse(atob(fileData.content)); // Decode Base64

            document.getElementById('drive-ui').style.display = 'none';
            document.getElementById('editor-ui').style.display = 'block';

            luckysheet.create({
                container: 'luckysheet',
                data: content.length > 0 ? content : [{ "name": "Sheet1", "status": 1, "order": 0, "celldata": [] }]
            });
        }

        // --- 3. SAVE SHEET ---
        async function saveCurrentSheet() {
            const data = luckysheet.getAllSheets();
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(data)))); // Secure Base64

            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${currentFileName}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${CONFIG.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Update ${currentFileName}`,
                    content: content,
                    sha: currentFileSha
                })
            });

            if(res.ok) {
                const updatedFile = await res.json();
                currentFileSha = updatedFile.content.sha; // Update SHA for next save
                alert('Saved to GitHub across all devices!');
            } else {
                alert('Error saving. Check console.');
            }
        }

        // --- 4. CREATE NEW ---
        function createNewSheet() {
            const name = prompt("Enter sheet name:") + ".json";
            if(name) openSheet(name, ''); 
        }

        loadFileList();
    </script>
</body>
</html>
