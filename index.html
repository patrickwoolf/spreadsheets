<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GitHub Cloud Drive</title>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css' />
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f4f4f9; }
        #drive-ui { max-width: 800px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .file-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; transition: background 0.2s; }
        .file-item:hover { background: #f0f7ff; cursor: pointer; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-create { background: #28a745; color: white; margin-bottom: 20px; }
        .btn-save { background: #007bff; color: white; }
        .btn-back { background: #6c757d; color: white; }
        #editor-ui { display: none; }
        .controls { background: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        #debug-log { background: #ffebeb; color: #b71c1c; padding: 10px; margin-top: 20px; border-radius: 4px; font-size: 12px; display: none; border: 1px solid #f44336; }
    </style>
</head>
<body>

    <div id="drive-ui">
        <h1>üìÅ My GitHub Drive</h1>
        <button class="btn-create" onclick="createNewSheet()">+ Create New Spreadsheet</button>
        <div id="file-list">Loading files from GitHub...</div>
        <div id="debug-log"></div>
    </div>

    <div id="editor-ui">
        <div class="controls">
            <span id="active-filename">Editing...</span>
            <div>
                <button class="btn-save" onclick="saveCurrentSheet()">üíæ SAVE TO GITHUB</button>
                <button class="btn-back" onclick="location.reload()">‚úñ EXIT</button>
            </div>
        </div>
        <div id="luckysheet" style="margin:0px;padding:0px;position:absolute;width:100%;height:calc(100% - 60px);left:0px;top:60px;"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            token: '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', 
            owner: 'patrickwoolf',
            repo: 'spreadsheets',
            folder: 'my-sheets'
        };

        let currentFileSha = '';
        let currentFileName = '';

        function logError(msg) {
            const log = document.getElementById('debug-log');
            log.style.display = 'block';
            log.innerHTML = `<strong>Error:</strong> ${msg}`;
        }

        // --- 1. FETCH ALL FILES ---
        async function loadFileList() {
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}`, {
                    headers: { 'Authorization': `token ${CONFIG.token}` }
                });
                
                if (!res.ok) throw new Error(await res.text());

                const files = await res.json();
                const listDiv = document.getElementById('file-list');
                listDiv.innerHTML = '';
                
                files.forEach(file => {
                    if(file.name.endsWith('.json')) {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        div.innerHTML = `<span>üìä ${file.name.replace('.json', '')}</span> <small>Edit &gt;</small>`;
                        div.onclick = () => openSheet(file.name, file.sha);
                        listDiv.appendChild(div);
                    }
                });
            } catch (err) {
                logError("Could not list files. Check folder name and Token permissions. " + err.message);
            }
        }

        // --- 2. OPEN A SHEET ---
        async function openSheet(name, sha) {
            try {
                currentFileName = name;
                currentFileSha = sha;
                document.getElementById('active-filename').innerText = `File: ${name}`;
                
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                    headers: { 'Authorization': `token ${CONFIG.ken}` }
                });
                const fileData = await res.json();
                
                // 1. Get the raw string content
                let rawContent = "";
                try {
                    rawContent = decodeURIComponent(escape(atob(fileData.content)));
                } catch (e) {
                    console.warn("Encoding issue, trying raw decode...");
                    rawContent = atob(fileData.content);
                }
        
                // 2. Safety Check: If file is empty or just whitespace, use default template
                let content;
                if (!rawContent || rawContent.trim() === "") {
                    console.log("File is empty, loading default template.");
                    content = [{"name": "Sheet1", "status": 1, "order": 0, "celldata": [], "config": {} }];
                } else {
                    content = JSON.parse(rawContent);
                }
        
                document.getElementById('drive-ui').style.display = 'none';
                document.getElementById('editor-ui').style.display = 'block';
        
                luckysheet.create({
                    container: 'luckysheet',
                    showinfobar: false,
                    lang: 'en',
                    data: content
                });
            } catch (err) {
                console.error(err);
                logError("Access Denied or Corrupt File: " + err.message);
            }
        }

        // --- 3. CREATE NEW SHEET ---
        async function createNewSheet() {
            const name = prompt("Enter new spreadsheet name:");
            if (!name) return;
            const fileName = name.endsWith('.json') ? name : name + '.json';

            // Default Luckysheet Template
            const initialData = [{"name": "Sheet1", "status": 1, "order": 0, "celldata": [], "config": {} }];
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(initialData))));

            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Create ${fileName}`,
                        content: content
                    })
                });

                if (!res.ok) throw new Error(await res.text());
                
                alert("Spreadsheet created!");
                loadFileList();
            } catch (err) {
                logError("Create Failed: " + err.message);
            }
        }

        // --- 4. SAVE DATA ---
        async function saveCurrentSheet() {
            try {
                const data = luckysheet.getAllSheets();
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data))));

                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${currentFileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update ${currentFileName}`,
                        content: content,
                        sha: currentFileSha
                    })
                });

                if (!res.ok) throw new Error(await res.text());
                
                const updatedFile = await res.json();
                currentFileSha = updatedFile.content.sha; // Important: Update SHA for next save
                alert("Changes saved to GitHub!");
            } catch (err) {
                alert("Save Failed: " + err.message);
            }
        }

        // --- KEYBOARD SHORTCUTS ---
        window.addEventListener('keydown', function (e) {
            // Check if Ctrl (Windows) or Command (Mac) is pressed AND 's' is pressed
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                
                // Prevent the browser from opening the "Save Page As..." dialog
                e.preventDefault();
                
                // Only trigger save if we are actually in the editor view
                if (document.getElementById('editor-ui').style.display === 'block') {
                    console.log("Ctrl+S detected. Saving...");
                    saveCurrentSheet();
                }
            }
        });

        
        // Initialize
        loadFileList();
    </script>
</body>
</html>
