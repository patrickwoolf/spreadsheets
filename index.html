<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GitHub Cloud Drive</title>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css' />
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f4f4f9; }
        #drive-ui { max-width: 800px; margin: 50px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; transition: background 0.2s; }
        .file-item:hover { background: #f0f7ff; }
        .file-name { cursor: pointer; color: #007bff; flex-grow: 1; font-weight: 500; }
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-create { background: #28a745; color: white; margin-bottom: 20px; font-size: 14px; }
        .btn-save { background: #007bff; color: white; }
        .btn-back { background: #6c757d; color: white; }
        .btn-copy { background: #17a2b8; color: white; margin-right: 5px; }
        .btn-del { background: #dc3545; color: white; }
        #editor-ui { display: none; }
        .controls { background: #333; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        #debug-log { background: #ffebeb; color: #b71c1c; padding: 10px; margin-top: 20px; border-radius: 4px; font-size: 12px; display: none; border: 1px solid #f44336; }
    </style>
</head>
<body>

    <div id="drive-ui">
        <h1>üìÅ My GitHub Drive</h1>
        <button class="btn-create" onclick="createNewSheet()">+ Create New Spreadsheet</button>
        <div id="file-list">Loading files from GitHub...</div>
        <div id="debug-log"></div>
    </div>

    <div id="editor-ui">
        <div class="controls">
            <span id="active-filename">Editing...</span>
            <div>
                <button class="btn-save" onclick="saveCurrentSheet()">üíæ SAVE (Ctrl+S)</button>
                <button class="btn-back" onclick="location.reload()">‚úñ EXIT</button>
            </div>
        </div>
        <div id="luckysheet" style="margin:0px;padding:0px;position:absolute;width:100%;height:calc(100% - 60px);left:0px;top:60px;"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Split your token here
        const ken1 = 'github_pat_11AKK62IA0yVqdui4EXKgn_'; 
        const ken2 = 'SLM4bzpcyr8qR8bl4l4FVSYXYTikK3lP90k5CXpvmK'; 
        const ken3 = 'nPNU5ULHC5GJnJfGl'; 

        const CONFIG = {
            ken: ken1 + ken2 + ken3, 
            owner: 'patrickwoolf',
            repo: 'spreadsheets',
            folder: 'my-sheets'
        };

        let currentFileSha = '';
        let currentFileName = '';

        function logError(msg) {
            const log = document.getElementById('debug-log');
            log.style.display = 'block';
            log.innerHTML = `<strong>Error:</strong> ${msg}`;
        }

        // --- 1. FETCH ALL FILES ---
        async function loadFileList() {
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}`, {
                    headers: { 'Authorization': `token ${CONFIG.ken}` }
                });
                
                if (!res.ok) throw new Error(await res.text());

                const files = await res.json();
                const listDiv = document.getElementById('file-list');
                listDiv.innerHTML = '';
                
                files.forEach(file => {
                    if(file.name.endsWith('.json')) {
                        const fileNameOnly = file.name.replace('.json', '');
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        div.innerHTML = `
                            <span class="file-name" onclick="openSheet('${file.name}', '${file.sha}')">üìä ${fileNameOnly}</span>
                            <div>
                                <button class="btn-copy" onclick="copySheet('${file.name}')">Copy</button>
                                <button class="btn-del" onclick="deleteSheet('${file.name}', '${file.sha}')">Del</button>
                            </div>
                        `;
                        listDiv.appendChild(div);
                    }
                });
            } catch (err) {
                logError("Could not list files. Check folder name and Token permissions. " + err.message);
            }
        }

        // --- 2. OPEN A SHEET ---
        async function openSheet(name, sha) {
            try {
                currentFileName = name;
                currentFileSha = sha;
                document.getElementById('active-filename').innerText = `Editing: ${name}`;
                
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                    headers: { 'Authorization': `token ${CONFIG.ken}` }
                });
                const fileData = await res.json();
                
                let rawContent = "";
                try {
                    rawContent = decodeURIComponent(escape(atob(fileData.content)));
                } catch (e) {
                    rawContent = atob(fileData.content);
                }

                let content;
                if (!rawContent || rawContent.trim() === "") {
                    content = [{"name": "Sheet1", "status": 1, "order": 0, "celldata": [], "config": {} }];
                } else {
                    content = JSON.parse(rawContent);
                }

                document.getElementById('drive-ui').style.display = 'none';
                document.getElementById('editor-ui').style.display = 'block';

                luckysheet.create({
                    container: 'luckysheet',
                    showinfobar: false,
                    lang: 'en',
                    data: content
                });
            } catch (err) {
                logError("Failed to open file: " + err.message);
            }
        }

        // --- 3. CREATE NEW SHEET ---
        async function createNewSheet() {
            const name = prompt("Enter new spreadsheet name:");
            if (!name) return;
            const fileName = name.endsWith('.json') ? name : name + '.json';
            const initialData = [{"name": "Sheet1", "status": 1, "order": 0, "celldata": [], "config": {} }];
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(initialData))));

            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.ken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: `Create ${fileName}`, content: content })
                });

                if (!res.ok) throw new Error(await res.text());
                alert("Spreadsheet created!");
                loadFileList();
            } catch (err) {
                logError("Create Failed: " + err.message);
            }
        }

        // --- 4. SAVE DATA ---
        async function saveCurrentSheet() {
            try {
                const data = luckysheet.getAllSheets();
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data))));

                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${currentFileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.ken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update ${currentFileName}`,
                        content: content,
                        sha: currentFileSha
                    })
                });

                if (!res.ok) throw new Error(await res.text());
                const updatedFile = await res.json();
                currentFileSha = updatedFile.content.sha;
                alert("Changes saved successfully!");
            } catch (err) {
                alert("Save Failed: " + err.message);
            }
        }

        // --- 5. DELETE SHEET ---
        async function deleteSheet(name, sha) {
            if (!confirm(`Delete "${name}" permanently?`)) return;
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${CONFIG.ken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: `Delete ${name}`, sha: sha })
                });
                if (!res.ok) throw new Error(await res.text());
                loadFileList();
            } catch (err) {
                alert("Delete failed: " + err.message);
            }
        }

        // --- 6. COPY SHEET ---
        async function copySheet(originalName) {
            const newName = prompt("New copy name:", originalName.replace('.json', '') + "_copy");
            if (!newName) return;
            const finalNewName = newName.endsWith('.json') ? newName : newName + '.json';

            try {
                const resGet = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${originalName}`, {
                    headers: { 'Authorization': `token ${CONFIG.ken}` }
                });
                const fileData = await resGet.json();

                const resPut = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${finalNewName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.ken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Copy ${originalName}`,
                        content: fileData.content
                    })
                });
                if (!resPut.ok) throw new Error(await resPut.text());
                loadFileList();
            } catch (err) {
                alert("Copy failed: " + err.message);
            }
        }

        // --- KEYBOARD SHORTCUTS ---
        window.addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (document.getElementById('editor-ui').style.display === 'block') {
                    saveCurrentSheet();
                }
            }
        });

        loadFileList();
    </script>
</body>
</html>
