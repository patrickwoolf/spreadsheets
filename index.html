<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GitHub Cloud Drive</title>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css' />
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f4f4f9; }
        #drive-ui { max-width: 800px; margin: 20px auto; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .file-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .file-name { cursor: pointer; color: #007bff; font-weight: 500; flex-grow: 1; min-width: 200px; padding: 5px 0; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; margin: 2px; }
        .btn-create { background: #28a745; color: white; width: 100%; margin-bottom: 20px; font-size: 16px; }
        .btn-save { background: #007bff; color: white; }
        .btn-back { background: #6c757d; color: white; }
        .btn-copy { background: #17a2b8; color: white; }
        .btn-del { background: #dc3545; color: white; }
        #editor-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: white; }
        .controls { background: #333; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        #luckysheet { position: absolute; width: 100%; height: calc(100% - 60px); left: 0; top: 60px; }
        #debug-log { background: #ffebeb; color: #b71c1c; padding: 10px; margin-top: 20px; border-radius: 4px; display: none; }
        @media (max-width: 600px) { .file-item { flex-direction: column; align-items: flex-start; } .file-actions { width: 100%; display: flex; justify-content: flex-end; } }
    </style>
</head>
<body>

    <div id="drive-ui">
        <h1>üìÅ My Cloud Drive</h1>
        <button class="btn-create" onclick="createNewSheet()">+ New Spreadsheet</button>
        <div id="file-list">Loading...</div>
        <div id="debug-log"></div>
    </div>

    <div id="editor-ui">
        <div class="controls">
            <span id="active-filename">Editing...</span>
            <div>
                <button class="btn-save" onclick="saveCurrentSheet()">SAVE</button>
                <button class="btn-back" onclick="location.reload()">EXIT</button>
            </div>
        </div>
        <div id="luckysheet"></div>
    </div>

    <script>
        // --- AUTH CONFIG ---
        const ken1 = 'github_pat_11AKK62IA0yVqdui4EXKgn_'; 
        const ken2 = 'SLM4bzpcyr8qR8bl4l4FVSYXYTikK3lP90k5CXpvmK'; 
        const ken3 = 'nPNU5ULHC5GJnJfGl'; 

        const CONFIG = {
            ken: ken1 + ken2 + ken3, 
            owner: 'patrickwoolf',
            repo: 'spreadsheets',
            folder: 'my-sheets'
        };

        let currentFileSha = '';
        let currentFileName = '';

        // --- HELPER: SAFE ENCODING ---
        // This replaces btoa() to handle emojis and complex characters properly
        function safeBtoa(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        }

        function safeAtob(str) {
            return decodeURIComponent(Array.prototype.map.call(atob(str), c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        }

        async function loadFileList() {
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}`, {
                    headers: { 'Authorization': `token ${CONFIG.ken}`, 'Cache-Control': 'no-cache' }
                });
                if (!res.ok) throw new Error("Folder not found or API error");
                const files = await res.json();
                const listDiv = document.getElementById('file-list');
                listDiv.innerHTML = '';
                files.forEach(file => {
                    if(file.name.endsWith('.json')) {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        div.innerHTML = `
                            <span class="file-name" onclick="openSheet('${file.name}', '${file.sha}')">üìä ${file.name.replace('.json', '')}</span>
                            <div class="file-actions">
                                <button class="btn-copy" onclick="copySheet('${file.name}')">Copy</button>
                                <button class="btn-del" onclick="deleteSheet('${file.name}', '${file.sha}')">Del</button>
                            </div>`;
                        listDiv.appendChild(div);
                    }
                });
            } catch (err) { document.getElementById('debug-log').style.display='block'; document.getElementById('debug-log').innerText = err.message; }
        }

        async function openSheet(name, sha) {
            try {
                currentFileName = name;
                currentFileSha = sha;
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                    headers: { 'Authorization': `token ${CONFIG.ken}`, 'Cache-Control': 'no-cache' }
                });
                const fileData = await res.json();
                const jsonStr = safeAtob(fileData.content);
                const content = JSON.parse(jsonStr || '[]');

                document.getElementById('drive-ui').style.display = 'none';
                document.getElementById('editor-ui').style.display = 'block';
                document.getElementById('active-filename').innerText = name;

                luckysheet.create({
                    container: 'luckysheet',
                    data: content,
                    showinfobar: false,
                    lang: 'en'
                });
            } catch (err) { alert("Error opening file: " + err.message); }
        }

        async function saveCurrentSheet() {
            try {
                const data = luckysheet.getAllSheets();
                if (!data || data.length === 0) throw new Error("No data to save");
                
                const jsonString = JSON.stringify(data);
                const base64Content = safeBtoa(jsonString);

                // Anti-Blank Check: If the generated string is suspiciously small, stop.
                if (base64Content.length < 5) {
                    alert("Error: Data appears empty. Save aborted to prevent blanking file.");
                    return;
                }

                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${currentFileName}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${CONFIG.ken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Update ${currentFileName}`,
                        content: base64Content,
                        sha: currentFileSha
                    })
                });

                if (!res.ok) throw new Error(await res.text());
                const result = await res.json();
                currentFileSha = result.content.sha;
                alert("Saved successfully!");
            } catch (err) { alert("Save failed: " + err.message); }
        }

        async function createNewSheet() {
            const name = prompt("Name:");
            if (!name) return;
            const fileName = name.endsWith('.json') ? name : name + '.json';
            const initial = [{"name": "Sheet1", "status": 1, "order": 0, "celldata": [], "config": {} }];
            const content = safeBtoa(JSON.stringify(initial));
            await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${fileName}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${CONFIG.ken}` },
                body: JSON.stringify({ message: `Create ${fileName}`, content: content })
            });
            loadFileList();
        }

        async function deleteSheet(name, sha) {
            if (!confirm("Delete " + name + "?")) return;
            await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${CONFIG.ken}` },
                body: JSON.stringify({ message: "Delete", sha: sha })
            });
            loadFileList();
        }

        async function copySheet(name) {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                headers: { 'Authorization': `token ${CONFIG.ken}` }
            });
            const file = await res.json();
            await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name.replace('.json', '_copy.json')}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${CONFIG.ken}` },
                body: JSON.stringify({ message: "Copy", content: file.content })
            });
            loadFileList();
        }

        window.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveCurrentSheet();
            }
        });

        loadFileList();
    </script>
</body>
</html>
