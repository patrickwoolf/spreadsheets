<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GitHub Cloud Drive</title>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css' />
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: #f4f4f9; color: var(--dark); }
        
        #drive-ui { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .file-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; gap: 10px; transition: background 0.2s; }
        .file-item:hover { background: #fdfdfd; }
        .file-info { cursor: pointer; flex-grow: 1; font-weight: 600; color: var(--primary); font-size: 1.1rem; }
        
        button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .btn-create { width: 100%; background: var(--success); color: white; margin-bottom: 20px; font-size: 1rem; height: 50px; }
        .btn-save { background: var(--success); color: white; }
        .btn-back { background: #6c757d; color: white; }
        .btn-del { background: #fff; color: var(--danger); border: 1px solid var(--danger); }
        .btn-del:hover { background: var(--danger); color: white; }

        #editor-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; }
        .controls { background: var(--dark); color: white; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        #luckysheet { width: 100%; height: calc(100% - 60px); position: absolute; top: 60px; left: 0; }
        
        #status-msg { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; border-radius: 4px; color: white; display: none; z-index: 3000; }
    </style>
</head>
<body>

    <div id="status-msg"></div>

    <div id="drive-ui">
        <h1>ðŸ“Š GitHub Cloud Drive</h1>
        <button class="btn-create" onclick="createNewSheet()">+ New Spreadsheet</button>
        <div id="file-list">Connecting to GitHub...</div>
    </div>

    <div id="editor-ui">
        <div class="controls">
            <strong id="active-filename">Sheet</strong>
            <div style="display: flex; gap: 10px;">
                <button class="btn-save" onclick="saveCurrentSheet()">ðŸ’¾ SAVE</button>
                <button class="btn-back" onclick="closeEditor()">âœ– EXIT</button>
            </div>
        </div>
        <div id="luckysheet"></div>
    </div>

    <script>
        // --- AUTH SETUP ---
        // This placeholder will be replaced by GitHub Actions during deployment
        const INJECTED_TOKEN = "__GH_TOKEN__"; 
    
        const CONFIG = {
            // Use injected token, or fallback to localStorage if you manually set it
            token: INJECTED_TOKEN.startsWith("__") ? localStorage.getItem('gh_drive_token') : INJECTED_TOKEN,
            owner: 'patrickwoolf',
            repo: 'spreadsheets',
            folder: 'my-sheets'
        };
    
    
        let currentFileSha = '';
        let currentFileName = '';

        // --- HELPERS ---
        function showStatus(text, color = '#333') {
            const el = document.getElementById('status-msg');
            el.innerText = text;
            el.style.backgroundColor = color;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function safeBtoa(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        }

        function safeAtob(str) {
            try {
                return decodeURIComponent(Array.prototype.map.call(atob(str), c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            } catch (e) { return atob(str); }
        }

        // --- FUNCTIONS ---
        async function loadFileList() {
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}`, {
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Cache-Control': 'no-cache' }
                });
                if (!res.ok) throw new Error("Connection failed. Check token/repo.");
                const files = await res.json();
                const listDiv = document.getElementById('file-list');
                listDiv.innerHTML = '';
                
                files.forEach(file => {
                    if(file.name.endsWith('.json')) {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        div.innerHTML = `
                            <div class="file-info" onclick="openSheet('${file.name}')">ðŸ“„ ${file.name.replace('.json', '')}</div>
                            <button class="btn-del" onclick="deleteSheet('${file.name}')">Del</button>`;
                        listDiv.appendChild(div);
                    }
                });
                if(!listDiv.innerHTML) listDiv.innerText = "No files found.";
            } catch (err) { document.getElementById('file-list').innerText = err.message; }
        }

        async function openSheet(name) {
            showStatus("Opening...", "#2196F3");
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Cache-Control': 'no-cache' }
                });
                const fileData = await res.json();
                
                currentFileName = name;
                currentFileSha = fileData.sha;

                const content = JSON.parse(safeAtob(fileData.content) || '[]');

                document.getElementById('drive-ui').style.display = 'none';
                document.getElementById('editor-ui').style.display = 'block';
                document.getElementById('active-filename').innerText = name.replace('.json', '');

                luckysheet.create({
                    container: 'luckysheet',
                    data: content,
                    lang: 'en',
                    showinfobar: false
                });
            } catch (err) { alert("Failed to load sheet."); }
        }

        async function saveCurrentSheet() {
            showStatus("Saving to GitHub...", "#f39c12");
            try {
                // Get the most recent SHA before saving to avoid 409 Conflict
                const check = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${currentFileName}`, {
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Cache-Control': 'no-cache' }
                });
                const latest = await check.json();
                
                const data = luckysheet.getAllSheets();
                const base64Content = safeBtoa(JSON.stringify(data));

                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${currentFileName}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: `Update ${currentFileName}`, 
                        content: base64Content, 
                        sha: latest.sha 
                    })
                });

                if (res.ok) {
                    const result = await res.json();
                    currentFileSha = result.content.sha;
                    showStatus("Saved!", "#27ae60");
                } else { throw new Error(); }
            } catch (err) { alert("Save failed. Try again."); }
        }

        async function createNewSheet() {
            const name = prompt("Filename:");
            if (!name) return;
            const fileName = name.endsWith('.json') ? name : name + '.json';
            const initial = [{"name": "Sheet1", "status": 1, "order": 0, "celldata": [], "config": {} }];
            
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${fileName}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${CONFIG.token}` },
                    body: JSON.stringify({ 
                        message: `Create ${fileName}`, 
                        content: safeBtoa(JSON.stringify(initial)) 
                    })
                });
                if(res.ok) loadFileList();
                else alert("File exists or error occurred.");
            } catch(e) { console.error(e); }
        }

        async function deleteSheet(name) {
            if (!confirm(`Delete ${name}?`)) return;
            try {
                const check = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Cache-Control': 'no-cache' }
                });
                const file = await check.json();
                
                await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${CONFIG.token}` },
                    body: JSON.stringify({ message: "Delete", sha: file.sha })
                });
                loadFileList();
            } catch(e) { alert("Delete failed."); }
        }

        function closeEditor() {
            if(confirm("Close editor? Ensure you have saved.")) {
                document.getElementById('editor-ui').style.display = 'none';
                document.getElementById('drive-ui').style.display = 'block';
                loadFileList();
            }
        }

        loadFileList();
    </script>
</body>
</html>
