<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GitHub Cloud Drive</title>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css' />
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #333; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f4f4f9; color: var(--dark); }
        
        #drive-ui { max-width: 800px; margin: 20px auto; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .file-item { display: flex; flex-direction: column; padding: 15px; border-bottom: 1px solid #eee; gap: 10px; }
        .file-info { cursor: pointer; flex-grow: 1; font-weight: 600; color: var(--primary); font-size: 1.1rem; }
        .file-actions { display: flex; gap: 8px; justify-content: flex-end; }
        
        button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-create { width: 100%; background: var(--success); color: white; margin-bottom: 20px; font-size: 1rem; height: 50px; }
        .btn-save { background: var(--primary); color: white; }
        .btn-back { background: #6c757d; color: white; }
        .btn-copy { background: #17a2b8; color: white; }
        .btn-del { background: var(--danger); color: white; }

        #editor-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; }
        .controls { background: var(--dark); color: white; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        #luckysheet { width: 100%; height: calc(100% - 60px); position: absolute; top: 60px; left: 0; }

        @media (min-width: 600px) {
            .file-item { flex-direction: row; align-items: center; }
            .btn-create { width: auto; }
        }
    </style>
</head>
<body>

    <div id="drive-ui">
        <h1>üìÅ My GitHub Drive</h1>
        <button class="btn-create" onclick="createNewSheet()">+ New Spreadsheet</button>
        <div id="file-list">Connecting to GitHub...</div>
    </div>

    <div id="editor-ui">
        <div class="controls">
            <strong id="active-filename">Sheet</strong>
            <div style="display: flex; gap: 5px;">
                <button class="btn-save" onclick="saveCurrentSheet()">üíæ SAVE</button>
                <button class="btn-back" onclick="location.reload()">‚úñ EXIT</button>
            </div>
        </div>
        <div id="luckysheet"></div>
    </div>

    <script>
        // --- AUTH SPLIT (To bypass GitHub Auto-Revocation) ---
        const p1 = 'github_pat_11AKK62IA07gCjbOsajxBp_';
        const p2 = 'l3ErZkVowkhdHtaE56WpwmL1YoAWSj4qtzPTcDjSO';
        const p3 = 'IiBHD4OVFJ984IynKC';

        const CONFIG = {
            token: p1 + p2 + p3, 
            owner: 'patrickwoolf',
            repo: 'spreadsheets',
            folder: 'my-sheets'
        };

        let currentFileSha = '';
        let currentFileName = '';

        // --- ENCODING UTILITIES ---
        function safeBtoa(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        }

        function safeAtob(str) {
            try {
                return decodeURIComponent(Array.prototype.map.call(atob(str), c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            } catch (e) { return atob(str); }
        }

        async function loadFileList() {
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}`, {
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Cache-Control': 'no-cache' }
                });
                if (!res.ok) throw new Error("Connection failed. Check if Token is expired or Repository is missing.");
                const files = await res.json();
                const listDiv = document.getElementById('file-list');
                listDiv.innerHTML = '';
                
                files.forEach(file => {
                    if(file.name.endsWith('.json')) {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        div.innerHTML = `
                            <div class="file-info" onclick="openSheet('${file.name}', '${file.sha}')">üìä ${file.name.replace('.json', '')}</div>
                            <div class="file-actions">
                                <button class="btn-copy" onclick="copySheet('${file.name}')">Copy</button>
                                <button class="btn-del" onclick="deleteSheet('${file.name}', '${file.sha}')">Del</button>
                            </div>`;
                        listDiv.appendChild(div);
                    }
                });
            } catch (err) { document.getElementById('file-list').innerText = "Error: " + err.message; }
        }

        async function openSheet(name, sha) {
            try {
                currentFileName = name;
                currentFileSha = sha;
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Cache-Control': 'no-cache' }
                });
                const fileData = await res.json();
                const jsonStr = safeAtob(fileData.content);
                const content = JSON.parse(jsonStr || '[]');

                document.getElementById('drive-ui').style.display = 'none';
                document.getElementById('editor-ui').style.display = 'block';
                document.getElementById('active-filename').innerText = name;

                if (window.luckysheet && luckysheet.destroy) { luckysheet.destroy(); }

                luckysheet.create({
                    container: 'luckysheet',
                    data: content,
                    showinfobar: false,
                    lang: 'en'
                });
            } catch (err) { alert("Open failed."); }
        }

        async function saveCurrentSheet() {
            try {
                const data = luckysheet.getAllSheets();
                const base64Content = safeBtoa(JSON.stringify(data));
                const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${currentFileName}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Save ${currentFileName}`, content: base64Content, sha: currentFileSha })
                });
                if (res.ok) {
                    const result = await res.json();
                    currentFileSha = result.content.sha;
                    alert("Saved!");
                } else { throw new Error("Network Conflict."); }
            } catch (err) { alert("Save failed: " + err.message); }
        }

        async function createNewSheet() {
            const name = prompt("Name:");
            if (!name) return;
            const fileName = name.endsWith('.json') ? name : name + '.json';
            const initial = [{"name": "Sheet1", "status": 1, "order": 0, "celldata": [], "config": {} }];
            const content = safeBtoa(JSON.stringify(initial));
            await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${fileName}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${CONFIG.token}` },
                body: JSON.stringify({ message: `Create ${fileName}`, content: content })
            });
            loadFileList();
        }

        async function deleteSheet(name, sha) {
            if (!confirm(`Delete ${name}?`)) return;
            await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${CONFIG.token}` },
                body: JSON.stringify({ message: "Delete", sha: sha })
            });
            loadFileList();
        }

        async function copySheet(name) {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name}`, {
                headers: { 'Authorization': `token ${CONFIG.token}` }
            });
            const file = await res.json();
            await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.folder}/${name.replace('.json', '_copy.json')}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${CONFIG.token}` },
                body: JSON.stringify({ message: "Copy", content: file.content })
            });
            loadFileList();
        }

        window.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (document.getElementById('editor-ui').style.display === 'block') saveCurrentSheet();
            }
        });

        loadFileList();
    </script>
</body>
</html>
